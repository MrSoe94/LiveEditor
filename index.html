<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTML JS Live Compiler</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .code-font { font-family: 'JetBrains Mono', monospace; }
        
        /* Custom Scrollbar for editors */
        textarea::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        textarea::-webkit-scrollbar-track {
            background: #1e293b;
        }
        textarea::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 5px;
        }
        textarea::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        .tab-active {
            background-color: #1e293b; /* slate-800 */
            color: #38bdf8; /* sky-400 */
            border-bottom: 2px solid #38bdf8;
        }
        .tab-inactive {
            color: #94a3b8; /* slate-400 */
            background-color: #0f172a; /* slate-900 */
        }
        .tab-inactive:hover {
            background-color: #1e293b;
            color: #e2e8f0;
        }
    </style>
</head>
<body class="bg-slate-900 text-white h-screen flex flex-col overflow-hidden">

    <!-- Hidden File Input for Upload -->
    <input type="file" id="file-upload" accept=".html,.htm" class="hidden" onchange="handleFileUpload(this)">

    <!-- Header -->
    <header class="h-14 bg-slate-950 border-b border-slate-800 flex items-center justify-between px-4 shrink-0">
        <div class="flex items-center gap-2">
            <!-- Icon Code -->
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-sky-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
            </svg>
            <h1 class="font-bold text-lg tracking-tight hidden md:block">Live<span class="text-sky-500">Compiler</span></h1>
        </div>
        
        <div class="flex gap-2 overflow-x-auto items-center">
            <!-- Upload Button -->
            <button onclick="triggerUpload()" class="px-3 py-1.5 text-xs font-medium bg-slate-800 hover:bg-slate-700 text-slate-300 rounded border border-slate-700 transition-colors flex items-center gap-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                </svg>
                Import
            </button>

            <!-- Head / Settings Button -->
            <button onclick="openLibraries()" class="px-3 py-1.5 text-xs font-medium bg-amber-600 hover:bg-amber-500 text-white rounded shadow-lg shadow-amber-900/20 transition-all flex items-center gap-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                Head / Libs
            </button>

            <!-- Clear Button -->
            <button onclick="clearCode()" class="px-3 py-1.5 text-xs font-medium bg-slate-800 hover:bg-orange-900/50 text-orange-400 hover:text-orange-300 rounded border border-slate-700 transition-colors flex items-center gap-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2M3 12l6.414 6.414a2 2 0 001.414.586H19a2 2 0 002-2V7a2 2 0 00-2-2h-9.172a2 2 0 00-1.414.586L3 12z" />
                </svg>
                Clear
            </button>

            <!-- Reset Button -->
            <button onclick="resetCode()" class="px-3 py-1.5 text-xs font-medium bg-slate-800 hover:bg-red-900/50 text-red-400 hover:text-red-300 rounded border border-slate-700 transition-colors flex items-center gap-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
                Reset
            </button>

            <!-- Full Script Button -->
            <button onclick="showFullSource()" class="px-3 py-1.5 text-xs font-medium bg-purple-600 hover:bg-purple-500 text-white rounded shadow-lg shadow-purple-900/20 transition-all flex items-center gap-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
                </svg>
                Full Script
            </button>

            <!-- Fullscreen Button -->
            <button onclick="openFullscreen()" class="px-3 py-1.5 text-xs font-medium bg-teal-600 hover:bg-teal-500 text-white rounded shadow-lg shadow-teal-900/20 transition-all flex items-center gap-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
                </svg>
                Fullscreen
            </button>

            <!-- Center Button (Default Active) -->
            <button onclick="toggleCenter()" id="btn-center" class="px-3 py-1.5 text-xs font-medium bg-indigo-600 hover:bg-indigo-500 text-white rounded border border-indigo-500 shadow-lg shadow-indigo-900/20 transition-colors flex items-center gap-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" /> 
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                Center
            </button>

            <!-- Run Button -->
            <button onclick="updatePreview()" class="px-3 py-1.5 text-xs font-medium bg-sky-600 hover:bg-sky-500 text-white rounded shadow-lg shadow-sky-900/20 transition-all flex items-center gap-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                Run
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col lg:flex-row overflow-hidden">
        
        <!-- Editor Section -->
        <div class="w-full lg:w-1/2 flex flex-col border-r border-slate-800 bg-slate-900">
            <!-- Tabs -->
            <div class="flex border-b border-slate-800 shrink-0">
                <button onclick="switchTab('html')" id="tab-html" class="tab-active flex-1 py-3 text-sm font-medium transition-colors flex justify-center items-center gap-2">
                    <span class="text-orange-500 font-bold">&lt;/&gt;</span> HTML
                </button>
                <button onclick="switchTab('css')" id="tab-css" class="tab-inactive flex-1 py-3 text-sm font-medium transition-colors flex justify-center items-center gap-2">
                    <span class="text-blue-400 font-bold">#</span> CSS
                </button>
                <button onclick="switchTab('js')" id="tab-js" class="tab-inactive flex-1 py-3 text-sm font-medium transition-colors flex justify-center items-center gap-2">
                    <span class="text-yellow-400 font-bold">{ }</span> JS
                </button>
            </div>

            <!-- Editor Areas -->
            <div class="relative flex-1 bg-[#1e293b] group">
                <!-- HTML Preprocessor Selector -->
                <div id="preprocessor-control-html" class="absolute top-4 right-14 z-20">
                    <select id="html-preprocessor" onchange="updatePreview()" class="bg-slate-800/90 text-xs text-slate-300 border border-slate-600 rounded px-2 py-1.5 hover:border-sky-500 focus:outline-none cursor-pointer backdrop-blur-sm shadow-sm">
                        <option value="html">HTML</option>
                        <option value="markdown">Markdown</option>
                        <option value="pug">Pug</option>
                        <option value="haml">Haml</option>
                        <option value="slim">Slim</option>
                    </select>
                </div>

                <!-- CSS Preprocessor Selector -->
                <div id="preprocessor-control-css" class="absolute top-4 right-14 z-20 hidden">
                    <select id="css-preprocessor" onchange="updatePreview()" class="bg-slate-800/90 text-xs text-slate-300 border border-slate-600 rounded px-2 py-1.5 hover:border-sky-500 focus:outline-none cursor-pointer backdrop-blur-sm shadow-sm">
                        <option value="css">CSS</option>
                        <option value="scss">SCSS</option>
                        <option value="less">LESS</option>
                    </select>
                </div>

                <!-- JS Preprocessor Selector -->
                <div id="preprocessor-control-js" class="absolute top-4 right-14 z-20 hidden">
                    <select id="js-preprocessor" onchange="updatePreview()" class="bg-slate-800/90 text-xs text-slate-300 border border-slate-600 rounded px-2 py-1.5 hover:border-sky-500 focus:outline-none cursor-pointer backdrop-blur-sm shadow-sm">
                        <option value="js">JavaScript</option>
                        <option value="babel">Babel (ES6+)</option>
                        <option value="typescript">TypeScript</option>
                        <option value="coffeescript">CoffeeScript</option>
                    </select>
                </div>

                <!-- Copy Button -->
                <button onclick="copyCurrentCode(this)" class="absolute top-4 right-4 z-10 p-2 text-slate-400 hover:text-white bg-slate-800/80 hover:bg-slate-700 backdrop-blur-sm rounded-lg transition-all opacity-0 group-hover:opacity-100 border border-slate-700 shadow-lg" title="Salin Kode">
                    <!-- Icon Copy -->
                    <svg id="icon-copy" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                    </svg>
                    <!-- Icon Check (Hidden by default) -->
                    <svg id="icon-check" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-400 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                </button>

                <!-- HTML Editor -->
                <textarea id="editor-html" class="editor-area w-full h-full bg-[#0f172a] text-slate-200 p-4 code-font text-sm outline-none resize-none leading-relaxed" spellcheck="false" placeholder="<!-- Tulis HTML di sini -->"></textarea>
                
                <!-- CSS Editor (Hidden by default) -->
                <textarea id="editor-css" class="editor-area w-full h-full bg-[#0f172a] text-slate-200 p-4 code-font text-sm outline-none resize-none leading-relaxed hidden" spellcheck="false" placeholder="/* Tulis CSS di sini */"></textarea>
                
                <!-- JS Editor (Hidden by default) -->
                <textarea id="editor-js" class="editor-area w-full h-full bg-[#0f172a] text-slate-200 p-4 code-font text-sm outline-none resize-none leading-relaxed hidden" spellcheck="false" placeholder="// Tulis JavaScript di sini"></textarea>
            </div>
            
            <!-- Status Bar -->
            <div class="h-8 bg-slate-950 border-t border-slate-800 flex items-center px-4 text-xs text-slate-500 justify-between shrink-0">
                <span id="status-msg">Siap</span>
                <span>Auto-save: Aktif</span>
            </div>
        </div>

        <!-- Preview Section -->
        <div class="w-full lg:w-1/2 flex flex-col bg-white h-1/2 lg:h-full relative">
            <div class="absolute top-0 left-0 bg-slate-200 text-slate-600 px-2 py-1 text-[10px] font-bold uppercase tracking-wider z-10 rounded-br shadow-sm">
                Preview
            </div>
            <iframe id="preview-frame" class="w-full h-full bg-white border-none" sandbox="allow-scripts allow-modals allow-same-origin"></iframe>
        </div>

    </main>

    <!-- Libraries/Head Modal -->
    <div id="libraries-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <!-- Modal Container with max-height and flex-col -->
        <div class="bg-slate-900 border border-slate-700 rounded-lg w-full max-w-lg shadow-2xl max-h-[90vh] flex flex-col">
            <div class="flex items-center justify-between p-4 border-b border-slate-700 bg-slate-950 rounded-t-lg shrink-0">
                <h3 class="font-bold text-white flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-amber-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    Stuff for &lt;head&gt;
                </h3>
                <button onclick="closeLibraries()" class="text-slate-400 hover:text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <!-- Scrollable Content -->
            <div class="p-6 overflow-y-auto">
                <p class="text-sm text-slate-400 mb-4">Tambahkan library eksternal, font, atau tag meta untuk <code class="bg-slate-800 px-1 rounded text-sky-400">&lt;head&gt;</code> di sini.</p>
                
                <div class="space-y-4 mb-4">
                    <!-- Libraries Group -->
                    <div>
                        <span class="text-[10px] font-bold text-slate-500 uppercase tracking-wider block mb-2">Libraries</span>
                        <div class="flex flex-wrap gap-2">
                            <button onclick="addLib('react')" class="px-2 py-1 text-xs bg-cyan-900/30 border border-cyan-700 hover:bg-cyan-900/50 text-cyan-400 rounded transition">+ React (with JSX)</button>
                            <button onclick="addLib('gsap')" class="px-2 py-1 text-xs bg-green-900/30 border border-green-700 hover:bg-green-900/50 text-green-400 rounded transition">+ GSAP</button>
                            <button onclick="addLib('tailwind')" class="px-2 py-1 text-xs bg-sky-900/30 border border-sky-700 hover:bg-sky-900/50 text-sky-400 rounded transition">+ Tailwind</button>
                            <button onclick="addLib('bootstrap')" class="px-2 py-1 text-xs bg-purple-900/30 border border-purple-700 hover:bg-purple-900/50 text-purple-400 rounded transition">+ Bootstrap</button>
                            <button onclick="addLib('fontawesome')" class="px-2 py-1 text-xs bg-blue-900/30 border border-blue-700 hover:bg-blue-900/50 text-blue-400 rounded transition">+ FontAwesome</button>
                            <button onclick="addLib('jquery')" class="px-2 py-1 text-xs bg-orange-900/30 border border-orange-700 hover:bg-orange-900/50 text-orange-400 rounded transition">+ jQuery</button>
                        </div>
                    </div>

                    <!-- CSS Base & Resets & Prefixing -->
                    <div>
                        <span class="text-[10px] font-bold text-slate-500 uppercase tracking-wider block mb-2">CSS Base, Resets & Prefixing</span>
                        <div class="flex flex-wrap gap-2">
                            <button onclick="addLib('normalize')" class="px-2 py-1 text-xs bg-pink-900/30 border border-pink-700 hover:bg-pink-900/50 text-pink-400 rounded transition">+ Normalize.css</button>
                            <button onclick="addLib('reset')" class="px-2 py-1 text-xs bg-rose-900/30 border border-rose-700 hover:bg-rose-900/50 text-rose-400 rounded transition">+ Reset.css</button>
                            <button onclick="addLib('prefixfree')" class="px-2 py-1 text-xs bg-indigo-900/30 border border-indigo-700 hover:bg-indigo-900/50 text-indigo-400 rounded transition">+ Vendor Prefixing</button>
                            <button onclick="addLib('neither')" class="px-2 py-1 text-xs bg-slate-700 border border-slate-500 hover:bg-slate-600 text-slate-200 rounded transition flex items-center gap-1">
                                <span class="font-bold text-red-400">×</span> Remove Base/Reset
                            </button>
                        </div>
                    </div>

                    <!-- Meta & Head Tags Group -->
                    <div>
                        <span class="text-[10px] font-bold text-slate-500 uppercase tracking-wider block mb-2">Meta & Head Tags</span>
                        <div class="flex flex-wrap gap-2">
                            <button onclick="addLib('viewport')" class="px-2 py-1 text-xs bg-slate-800 border border-slate-600 hover:bg-slate-700 text-slate-300 rounded transition">+ Meta Viewport</button>
                            <button onclick="addLib('charset')" class="px-2 py-1 text-xs bg-slate-800 border border-slate-600 hover:bg-slate-700 text-slate-300 rounded transition">+ Meta Charset</button>
                            <button onclick="addLib('googlefont')" class="px-2 py-1 text-xs bg-slate-800 border border-slate-600 hover:bg-slate-700 text-slate-300 rounded transition">+ Google Font (Contoh)</button>
                        </div>
                    </div>
                </div>

                <!-- Add External URL Section -->
                <div class="mb-4 pt-4 border-t border-slate-700">
                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider block mb-2">Add External Stylesheet / Script (URL)</label>
                    <div class="flex gap-2">
                        <input type="text" id="external-url" class="flex-1 bg-slate-800 border border-slate-600 rounded px-3 py-1.5 text-xs text-slate-200 focus:outline-none focus:border-sky-500 placeholder-slate-500" placeholder="https://cdn.example.com/style.css atau script.js">
                        <button onclick="addExternal('css')" class="px-3 py-1.5 text-xs bg-blue-600 hover:bg-blue-500 text-white font-medium rounded transition flex items-center gap-1">
                            <span>+ CSS</span>
                        </button>
                        <button onclick="addExternal('js')" class="px-3 py-1.5 text-xs bg-yellow-600 hover:bg-yellow-500 text-white font-medium rounded transition flex items-center gap-1">
                            <span>+ JS</span>
                        </button>
                    </div>
                </div>

                <textarea id="lib-content" class="w-full h-40 bg-[#0f172a] border border-slate-700 rounded text-slate-300 p-3 code-font text-xs outline-none focus:border-sky-500 resize-none leading-relaxed" placeholder="<script src='...'></script>&#10;<link rel='stylesheet' href='...'>&#10;<meta name='viewport' content='...'>"></textarea>
                
                <!-- Footer Modal Updated: Added Clear Button -->
                <div class="flex justify-between items-center mt-4 pt-4 border-t border-slate-700 sticky bottom-0 bg-slate-900/95 backdrop-blur">
                    <button onclick="clearLibraries()" class="px-3 py-2 bg-slate-800 hover:bg-red-900/30 text-red-400 hover:text-red-300 border border-slate-600 hover:border-red-800/50 text-xs font-medium rounded transition flex items-center gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                        Clear All
                    </button>
                    <button onclick="saveLibraries()" class="px-4 py-2 bg-sky-600 hover:bg-sky-500 text-white text-sm font-medium rounded transition shadow-lg shadow-sky-900/20">Simpan & Jalankan</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Full Script Modal -->
    <div id="source-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-slate-900 border border-slate-700 rounded-lg w-full max-w-4xl h-[80vh] flex flex-col shadow-2xl">
            <div class="flex items-center justify-between p-4 border-b border-slate-700 bg-slate-950 rounded-t-lg">
                <h3 class="font-bold text-white">Full Source Code</h3>
                <div class="flex gap-2">
                    <button onclick="downloadSource()" class="px-3 py-1.5 text-xs font-medium bg-green-600 hover:bg-green-500 text-white rounded shadow-lg shadow-green-900/20 transition-all flex items-center gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                        Download .html
                    </button>
                    <button onclick="copySource()" class="px-3 py-1.5 text-xs font-medium bg-slate-800 hover:bg-slate-700 text-sky-400 rounded border border-slate-600 transition-colors">
                        Salin Kode
                    </button>
                    <button onclick="closeModal()" class="text-slate-400 hover:text-white">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            </div>
            <div class="flex-1 p-0 relative">
                <textarea id="full-source-area" class="w-full h-full bg-[#0f172a] text-slate-300 p-4 code-font text-xs md:text-sm outline-none resize-none leading-relaxed" readonly></textarea>
            </div>
        </div>
    </div>

    <!-- Fullscreen Preview Modal -->
    <div id="fullscreen-modal" class="fixed inset-0 bg-white z-[60] hidden flex flex-col">
        <div class="h-10 bg-slate-900 flex items-center justify-between px-4 shrink-0 border-b border-slate-700">
            <span class="text-sm font-bold text-slate-300">Fullscreen Preview</span>
            <button onclick="closeFullscreen()" class="text-slate-400 hover:text-white hover:bg-slate-800 px-3 py-1 rounded transition-colors flex items-center gap-1 text-xs">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
                Keluar (Esc)
            </button>
        </div>
        <iframe id="fullscreen-frame" class="flex-1 w-full h-full border-none" sandbox="allow-scripts allow-modals allow-same-origin"></iframe>
    </div>

    <script>
        // Default Code with GSAP Example
        const defaultHTML = `<!-- Contoh Struktur HTML dengan Animasi -->
<div class="container">
  <h1 class="title">Halo, Dunia!</h1>
  <p class="subtitle">Animasi dengan GSAP</p>
  <div class="box"></div>
  <button id="animBtn">Animasi Ulang</button>
</div>`;

        const defaultCSS = `/* Styling Halaman */
body {
  font-family: sans-serif;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
  margin: 0;
  background: #0f172a;
  color: white;
}

.container {
  background: #1e293b;
  padding: 2rem;
  border-radius: 12px;
  text-align: center;
  width: 90%;
  max-width: 400px;
  border: 1px solid #334155;
}

.title { color: #38bdf8; }
.subtitle { color: #94a3b8; margin-bottom: 20px; }

.box {
  width: 50px;
  height: 50px;
  background: #f43f5e;
  margin: 20px auto;
  border-radius: 8px;
}

button {
  background: #38bdf8;
  color: #0f172a;
  border: none;
  padding: 10px 20px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: bold;
}
button:hover { background: #7dd3fc; }`;

        const defaultJS = `// Pastikan library GSAP sudah ditambahkan di menu "Libraries"
// Jika belum, klik tombol Libraries > + GSAP > Simpan

if (typeof gsap !== 'undefined') {
  // Animasi awal
  gsap.from(".container", { duration: 1, y: -50, opacity: 0, ease: "bounce" });
  gsap.from(".box", { duration: 1, rotation: 360, scale: 0, delay: 0.5 });
  
  // Interaksi tombol
  document.getElementById('animBtn').addEventListener('click', () => {
    gsap.to(".box", { 
      duration: 0.5, 
      rotation: "+=360", 
      scale: 1.2, 
      yoyo: true, 
      repeat: 1 
    });
  });
} else {
  document.querySelector('.subtitle').textContent = "GSAP Library belum dimuat!";
  document.querySelector('.subtitle').style.color = "red";
  console.error("GSAP not found. Please add it via the Libraries menu.");
}`;

        // Variables declared at top scope
        let htmlEditor, cssEditor, jsEditor, previewFrame, statusMsg, sourceModal, fullSourceArea, fullscreenModal, fullscreenFrame, fileUploadInput, librariesModal, libContent, cssPreprocessorSelect, cssPreprocessorControl, jsPreprocessorSelect, jsPreprocessorControl, htmlPreprocessorSelect, htmlPreprocessorControl;
        
        // Variable state for Centering (Default True)
        let isCentered = true;

        // Initialize elements - moved to a function for safety
        function initElements() {
             htmlEditor = document.getElementById('editor-html');
             cssEditor = document.getElementById('editor-css');
             jsEditor = document.getElementById('editor-js');
             previewFrame = document.getElementById('preview-frame');
             statusMsg = document.getElementById('status-msg');
             
             sourceModal = document.getElementById('source-modal');
             fullSourceArea = document.getElementById('full-source-area');

             fullscreenModal = document.getElementById('fullscreen-modal');
             fullscreenFrame = document.getElementById('fullscreen-frame');
             
             fileUploadInput = document.getElementById('file-upload');
             
             librariesModal = document.getElementById('libraries-modal');
             libContent = document.getElementById('lib-content');

             cssPreprocessorSelect = document.getElementById('css-preprocessor');
             cssPreprocessorControl = document.getElementById('preprocessor-control-css');
             
             jsPreprocessorSelect = document.getElementById('js-preprocessor');
             jsPreprocessorControl = document.getElementById('preprocessor-control-js');

             htmlPreprocessorSelect = document.getElementById('html-preprocessor');
             htmlPreprocessorControl = document.getElementById('preprocessor-control-html');
        }

        // Tab Switching Logic
        function switchTab(type) {
            // Hide all editors
            document.querySelectorAll('.editor-area').forEach(el => el.classList.add('hidden'));
            
            // Reset tab styles
            document.querySelectorAll('[id^="tab-"]').forEach(el => {
                el.classList.remove('tab-active');
                el.classList.add('tab-inactive');
            });

            // Show selected editor
            document.getElementById(`editor-${type}`).classList.remove('hidden');
            
            // Highlight selected tab
            const activeTab = document.getElementById(`tab-${type}`);
            activeTab.classList.remove('tab-inactive');
            activeTab.classList.add('tab-active');

            // Show preprocessor controls
            if (cssPreprocessorControl) cssPreprocessorControl.classList.add('hidden');
            if (jsPreprocessorControl) jsPreprocessorControl.classList.add('hidden');
            if (htmlPreprocessorControl) htmlPreprocessorControl.classList.add('hidden');

            if (type === 'css') {
                if(cssPreprocessorControl) cssPreprocessorControl.classList.remove('hidden');
            } else if (type === 'js') {
                if(jsPreprocessorControl) jsPreprocessorControl.classList.remove('hidden');
            } else if (type === 'html') {
                if(htmlPreprocessorControl) htmlPreprocessorControl.classList.remove('hidden');
            }
        }

        // Toggle Center Function
        function toggleCenter() {
            isCentered = !isCentered;
            const btn = document.getElementById('btn-center');
            
            if (isCentered) {
                // Active Style
                btn.classList.remove('bg-slate-800', 'text-slate-300', 'border-slate-700');
                btn.classList.add('bg-indigo-600', 'text-white', 'border-indigo-500', 'shadow-lg', 'shadow-indigo-900/20');
            } else {
                // Inactive Style
                btn.classList.add('bg-slate-800', 'text-slate-300', 'border-slate-700');
                btn.classList.remove('bg-indigo-600', 'text-white', 'border-indigo-500', 'shadow-lg', 'shadow-indigo-900/20');
            }
            
            updatePreview().catch(console.error);
        }

        // Initialize from LocalStorage or Defaults
        function init() {
            // Ensure elements are fetched
            if (!htmlEditor) initElements();

            htmlEditor.value = localStorage.getItem('lc_html') || defaultHTML;
            cssEditor.value = localStorage.getItem('lc_css') || defaultCSS;
            jsEditor.value = localStorage.getItem('lc_js') || defaultJS;
            libContent.value = localStorage.getItem('lc_libs') || '';
            
            if (cssPreprocessorSelect) {
                cssPreprocessorSelect.value = localStorage.getItem('lc_css_preprocessor') || 'css';
            }
            if (jsPreprocessorSelect) {
                jsPreprocessorSelect.value = localStorage.getItem('lc_js_preprocessor') || 'js';
            }
            if (htmlPreprocessorSelect) {
                htmlPreprocessorSelect.value = localStorage.getItem('lc_html_preprocessor') || 'html';
            }
            
            // Initial render without delay
            updatePreview().catch(console.error);
        }

        // Reset Code
        function resetCode() {
            if(confirm('Apakah Anda yakin ingin mereset kode ke default? Kode saat ini akan hilang.')) {
                htmlEditor.value = defaultHTML;
                cssEditor.value = defaultCSS;
                jsEditor.value = defaultJS;
                // Optional: Reset libs too or keep them? Let's keep them for convenience.
                updatePreview().catch(console.error);
            }
        }

        // Clear Code
        function clearCode() {
            if(confirm('Apakah Anda yakin ingin menghapus SEMUA kode (HTML, CSS, JS)? Editor akan menjadi kosong.')) {
                htmlEditor.value = '';
                cssEditor.value = '';
                jsEditor.value = '';
                updatePreview().catch(console.error);
            }
        }

        // Copy Current Code Logic
        function copyCurrentCode(btn) {
            // Find which editor is currently visible
            const editors = ['editor-html', 'editor-css', 'editor-js'];
            let activeContent = '';
            
            editors.forEach(id => {
                const el = document.getElementById(id);
                if (!el.classList.contains('hidden')) {
                    activeContent = el.value;
                }
            });

            if (activeContent) {
                // Fallback to simpler method if navigator.clipboard fails in frame
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(activeContent).then(showSuccess).catch(tryFallback);
                } else {
                    tryFallback();
                }

                function tryFallback() {
                    const textArea = document.createElement("textarea");
                    textArea.value = activeContent;
                    document.body.appendChild(textArea);
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        showSuccess();
                    } catch (err) {
                        console.error('Copy failed', err);
                        alert('Gagal menyalin kode. Izin browser mungkin dibatasi.');
                    }
                    document.body.removeChild(textArea);
                }

                function showSuccess() {
                    // Visual Feedback
                    const iconCopy = btn.querySelector('#icon-copy');
                    const iconCheck = btn.querySelector('#icon-check');
                    
                    iconCopy.classList.add('hidden');
                    iconCheck.classList.remove('hidden');
                    btn.classList.add('border-green-500/50');

                    setTimeout(() => {
                        iconCopy.classList.remove('hidden');
                        iconCheck.classList.add('hidden');
                        btn.classList.remove('border-green-500/50');
                    }, 2000);
                }
            }
        }

        // Libraries Logic
        function openLibraries() {
            librariesModal.classList.remove('hidden');
        }

        function closeLibraries() {
            librariesModal.classList.add('hidden');
        }

        function addLib(type) {
            let tag = '';
            // Define strict strings for removal matching (legacy)
            const normalizeTag = '<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css">';
            const resetTag = '<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reset-css@5.0.2/reset.min.css">';

            switch(type) {
                // === CSS Base & Reset & Prefixing ===
                case 'normalize':
                    tag = normalizeTag;
                    break;
                case 'reset':
                    tag = resetTag;
                    break;
                case 'prefixfree':
                    tag = '<script src="https://cdnjs.cloudflare.com/ajax/libs/prefixfree/1.0.7/prefixfree.min.js"><\/script>';
                    break;
                case 'neither':
                    // UPDATE: Menggunakan Regex Replace agar penghapusan lebih pasti
                    let currentContent = libContent.value;
                    
                    // Hapus baris yang mengandung normalize.min.css (case insensitive, global)
                    currentContent = currentContent.replace(/.*normalize\.min\.css.*\n?/gi, "");
                    
                    // Hapus baris yang mengandung reset.min.css (case insensitive, global)
                    currentContent = currentContent.replace(/.*reset\.min\.css.*\n?/gi, "");
                    
                    // Update value textarea dan trim spasi berlebih
                    libContent.value = currentContent.trim();
                    
                    // Efek Visual Tombol yang Stabil
                    const btn = document.querySelector('button[onclick="addLib(\'neither\')"]');
                    if(btn) {
                        if (btn.dataset.isAnimating) return;
                        
                        btn.dataset.isAnimating = "true";
                        const originalHTML = '<span class="font-bold text-red-400">×</span> Remove Base/Reset';
                        
                        btn.innerHTML = '<span class="font-bold text-green-400">✓</span> Removed!';
                        btn.classList.add('border-green-500', 'text-green-300');
                        
                        setTimeout(() => {
                            btn.innerHTML = originalHTML;
                            btn.classList.remove('border-green-500', 'text-green-300');
                            delete btn.dataset.isAnimating; 
                        }, 1000);
                    }
                    return; // Keluar fungsi

                // === Existing Libraries ===
                case 'react':
                    tag = '<script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin><\/script>\n' +
                          '<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin><\/script>\n' +
                          '<script src="https://unpkg.com/@babel/standalone/babel.min.js"><\/script>';
                    break;
                case 'gsap':
                    tag = '<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"><\/script>';
                    break;
                case 'tailwind':
                    tag = '<script src="https://cdn.tailwindcss.com"><\/script>';
                    break;
                case 'bootstrap':
                    tag = '<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">';
                    break;
                case 'fontawesome':
                    tag = '<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">';
                    break;
                case 'jquery':
                    tag = '<script src="https://code.jquery.com/jquery-3.7.1.min.js"><\/script>';
                    break;
                // === Meta Tags ===
                case 'viewport':
                    tag = '<meta name="viewport" content="width=device-width, initial-scale=1.0">';
                    break;
                case 'charset':
                    tag = '<meta charset="UTF-8">';
                    break;
                case 'googlefont':
                    tag = '<!-- Contoh Google Font: Roboto -->\n<link rel="preconnect" href="https://fonts.googleapis.com">\n<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>\n<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">';
                    break;
            }
            
            if (libContent.value.indexOf(tag) === -1) {
                libContent.value += (libContent.value ? '\n' : '') + tag;
            }
        }

        // NEW: Add External URL Logic
        function addExternal(type) {
            const urlInput = document.getElementById('external-url');
            const url = urlInput.value.trim();
            
            if (!url) {
                alert('Mohon masukkan URL terlebih dahulu.');
                return;
            }

            let tag = '';
            if (type === 'css') {
                tag = `<link rel="stylesheet" href="${url}">`;
            } else if (type === 'js') {
                tag = `<script src="${url}"><\/script>`;
            }

            // Append to textarea
            if (libContent.value.indexOf(url) === -1) {
                const separator = libContent.value ? '\n' : '';
                libContent.value += separator + tag;
                urlInput.value = ''; // Reset input
                
                // Visual feedback (optional)
                const originalPlaceholder = urlInput.placeholder;
                urlInput.placeholder = "Berhasil ditambahkan!";
                setTimeout(() => urlInput.placeholder = originalPlaceholder, 1500);
            } else {
                alert('URL ini sepertinya sudah ada di daftar.');
            }
        }

        // FUNGSI BARU: Clear Libraries
        function clearLibraries() {
            if (libContent.value.trim() === '') return; // Tidak ada yang perlu dihapus
            
            if(confirm('Apakah Anda yakin ingin menghapus semua library dan pengaturan head?')) {
                libContent.value = '';
            }
        }

        function saveLibraries() {
            localStorage.setItem('lc_libs', libContent.value);
            closeLibraries();
            updatePreview().catch(console.error);
        }

        // Upload/Import Logic
        function triggerUpload() {
            if(confirm('Mengimpor file akan menimpa kode yang ada di editor saat ini. Lanjutkan?')) {
                fileUploadInput.click();
            }
        }

        function handleFileUpload(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                const parser = new DOMParser();
                const doc = parser.parseFromString(content, 'text/html');

                // Extract Libraries (simple heuristic: scripts with src or links with rel=stylesheet in head)
                const headChildren = doc.head.children;
                let libs = '';
                for(let el of headChildren) {
                    if ((el.tagName === 'SCRIPT' && el.src) || (el.tagName === 'LINK' && el.rel === 'stylesheet')) {
                        libs += el.outerHTML + '\n';
                    }
                }
                
                // Extract CSS
                const styles = doc.querySelectorAll('style');
                let cssContent = '';
                styles.forEach(style => {
                    cssContent += style.innerHTML + '\n\n';
                    style.remove();
                });

                // Extract JS
                const scripts = doc.querySelectorAll('script');
                let jsContent = '';
                scripts.forEach(script => {
                    if (!script.src) {
                         jsContent += script.innerHTML + '\n\n';
                         script.remove();
                    }
                });

                // Extract Body
                let htmlContent = "";
                if (doc.body) {
                    htmlContent = doc.body.innerHTML.replace(/^\s*[\r\n]/gm, ''); 
                } else {
                    htmlContent = doc.documentElement.innerHTML;
                }

                htmlEditor.value = htmlContent.trim();
                cssEditor.value = cssContent.trim();
                jsEditor.value = jsContent.trim();
                libContent.value = libs.trim();

                input.value = '';
                
                saveLibraries(); // Save the imported libs
                updatePreview().catch(console.error);
                alert('File berhasil diimpor!');
            };
            reader.readAsText(file);
        }

        // Helper: Load Script Asynchronously with CORS
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.crossOrigin = "anonymous"; // Added for better error reporting
                script.onload = resolve;
                script.onerror = () => reject(new Error(`Failed to load script: ${src}`));
                document.head.appendChild(script);
            });
        }

        // Helper: Compile CSS
        async function compileCSS(code, type) {
            if (type === 'css') return code;
            
            if (type === 'scss') {
                if (!window.Sass) {
                    statusMsg.textContent = "Loading Sass Compiler...";
                    try {
                        await loadScript('https://cdnjs.cloudflare.com/ajax/libs/sass.js/0.11.1/sass.sync.min.js');
                    } catch(e) {
                        return `/* Gagal memuat Sass: ${e} */`;
                    }
                }
                
                return new Promise(resolve => {
                    Sass.compile(code, (result) => {
                        if (result.status === 0) {
                            resolve(result.text);
                        } else {
                            resolve(`/* Sass Error Line ${result.line}: ${result.message} */ \n body:before { content: "Sass Error: ${result.message}"; color: red; background: white; padding: 10px; display: block; }`);
                        }
                    });
                });
            }

            if (type === 'less') {
                if (!window.less) {
                    statusMsg.textContent = "Loading Less Compiler...";
                    try {
                        await loadScript('https://cdnjs.cloudflare.com/ajax/libs/less.js/4.1.3/less.min.js');
                    } catch(e) {
                         return `/* Gagal memuat Less: ${e} */`;
                    }
                }

                return new Promise(resolve => {
                    less.render(code, (e, output) => {
                        if (e) {
                             resolve(`/* Less Error: ${e.message} */ \n body:before { content: "Less Error: ${e.message}"; color: red; background: white; padding: 10px; display: block; }`);
                        } else {
                            resolve(output.css);
                        }
                    });
                });
            }

            return code;
        }

        // Helper: Compile JS
        async function compileJS(code, type) {
            if (type === 'js') return code;

            // Shared Babel Loader for TS and Babel modes
            if (type === 'typescript' || type === 'babel') {
                if (!window.Babel) {
                    statusMsg.textContent = "Loading Babel...";
                    try {
                         await loadScript('https://unpkg.com/@babel/standalone/babel.min.js');
                    } catch(e) {
                        return `console.error("Failed to load Babel: ${e.message}");`;
                    }
                }
            }

            if (type === 'babel') {
                try {
                    // Compile ES6+/JSX to standard JS
                    const res = Babel.transform(code, { presets: ['env', 'react'], filename: 'script.js' });
                    return res.code;
                } catch (e) {
                     return `console.error("Babel Error: ${e.message.replace(/"/g, '\\"')}");`;
                }
            }

            if (type === 'typescript') {
                try {
                    const res = Babel.transform(code, { presets: ['typescript', 'react', 'env'], filename: 'script.ts' });
                    return res.code;
                } catch (e) {
                     return `console.error("TypeScript Error: ${e.message.replace(/"/g, '\\"')}");`;
                }
            }

            if (type === 'coffeescript') {
                if (!window.CoffeeScript) {
                    statusMsg.textContent = "Loading CoffeeScript...";
                    try {
                        await loadScript('https://cdnjs.cloudflare.com/ajax/libs/coffeescript/2.7.0/coffeescript.min.js');
                    } catch(e) {
                        return `console.error("Failed to load CoffeeScript: ${e.message}");`;
                    }
                }
                try {
                    return CoffeeScript.compile(code, { bare: true });
                } catch (e) {
                     return `console.error("CoffeeScript Error: ${e.message.replace(/"/g, '\\"')}");`;
                }
            }

            return code;
        }

        // Helper: Compile Slim Lite (Browser Implementation)
        function compileSlimLite(code) {
            const lines = code.split('\n');
            let output = '';
            const stack = []; // { indent: number, tag: string }

            lines.forEach((line, index) => {
                if (!line.trim()) return;

                // Determine indentation
                const indentMatch = line.match(/^\s*/);
                const indent = indentMatch ? indentMatch[0].length : 0;
                const content = line.trim();
                
                // Close tags based on indentation
                while (stack.length > 0 && stack[stack.length - 1].indent >= indent) {
                    output += `</${stack.pop().tag}>`;
                }

                // Handle special characters
                if (content.startsWith('|')) {
                    output += content.substring(1) + ' ';
                    return;
                }
                
                if (content.startsWith('/')) {
                    // Comment - ignore
                    return;
                }
                
                if (content.startsWith('=')) {
                    // Output - wrap in span or just text
                     output += content.substring(1) + ' ';
                     return;
                }

                // Regex: tag#id.class or #id.class or .class
                // Captures: 1:tag, 2:id, 3:classes, 5:text
                const match = content.match(/^([a-z0-9:-]+)?(#[a-z0-9:-]+)?((\.[a-z0-9:-]+)*)(?:\s+(.*))?$/i);
                
                if (match) {
                    let tag = match[1] || 'div';
                    const id = match[2];
                    const classes = match[3];
                    const text = match[5];

                    // If line starts with . or # and no tag is specified, it's a div
                    if (!match[1] && (id || classes)) {
                        tag = 'div';
                    }

                    let attributes = '';
                    if (id) attributes += ` id="${id.substring(1)}"`;
                    if (classes) {
                        const classList = classes.split('.').filter(c => c).join(' ');
                        attributes += ` class="${classList}"`;
                    }

                    output += `<${tag}${attributes}>`;

                    if (text) {
                        if (text.startsWith('=')) {
                             // Mimic ruby output
                             output += text.substring(1); 
                        } else {
                             output += text;
                        }
                        output += `</${tag}>`;
                    } else {
                        stack.push({ indent: indent, tag: tag });
                    }
                } else {
                    // Fallback for plain text or unknown lines not matching tag syntax
                    // Usually Slim treats unknown lines as text if they don't look like tags? 
                    // Or they must be prefixed with |
                    // For this lite parser, if it fails regex but has text, we treat as text.
                    output += content + ' ';
                }
            });

            // Close remaining tags
            while (stack.length > 0) {
                output += `</${stack.pop().tag}>`;
            }

            return output;
        }

        // Helper: Compile HTML (Updated with Haml & Slim)
        async function compileHTML(code, type) {
            if (type === 'html') return code;

            if (type === 'markdown') {
                if (!window.marked) {
                    statusMsg.textContent = "Loading Markdown Compiler...";
                    try {
                        await loadScript('https://cdn.jsdelivr.net/npm/marked/marked.min.js');
                    } catch(e) {
                        return `<!-- Failed to load marked: ${e.message} -->`;
                    }
                }
                try {
                    return marked.parse(code);
                } catch(e) {
                    return `<!-- Markdown Error: ${e.message} -->`;
                }
            }

            if (type === 'pug') {
                if (!window.pug) {
                    statusMsg.textContent = "Loading Pug Compiler...";
                    try {
                        await loadScript('https://cdnjs.cloudflare.com/ajax/libs/pug/3.0.2/pug.min.js');
                    } catch(e) {
                        return `<!-- Failed to load Pug: ${e.message} -->`;
                    }
                }
                try {
                    return pug.render(code);
                } catch(e) {
                    return `<!-- Pug Error: ${e.message} -->`;
                }
            }

            if (type === 'haml') {
                if (!window.haml) {
                    statusMsg.textContent = "Loading Haml Compiler...";
                    try {
                        // Load clientside-haml-js
                        await loadScript('https://cdnjs.cloudflare.com/ajax/libs/clientside-haml-js/1.0.0/haml.min.js');
                    } catch(e) {
                        return `<!-- Failed to load Haml: ${e.message} -->`;
                    }
                }
                try {
                    // clientside-haml-js exposes 'haml.compileHaml' which returns a function
                    return haml.compileHaml({source: code})();
                } catch(e) {
                    return `<!-- Haml Error: ${e.message} -->`;
                }
            }

            if (type === 'slim') {
                // Custom Lite Parser
                try {
                   return compileSlimLite(code);
                } catch(e) {
                   return `<!-- Slim Lite Error: ${e.message} -->`;
                }
            }

            return code;
        }

        // Fullscreen Logic
        function openFullscreen() {
            const rawCss = cssEditor.value;
            const rawJs = jsEditor.value;
            const rawHtml = htmlEditor.value;
            const cssPrep = cssPreprocessorSelect ? cssPreprocessorSelect.value : 'css';
            const jsPrep = jsPreprocessorSelect ? jsPreprocessorSelect.value : 'js';
            const htmlPrep = htmlPreprocessorSelect ? htmlPreprocessorSelect.value : 'html';
            
            Promise.all([
                compileCSS(rawCss, cssPrep),
                compileJS(rawJs, jsPrep),
                compileHTML(rawHtml, htmlPrep)
            ]).then(([css, js, html]) => {
                const libs = libContent.value;
                
                let scriptAttr = '';
                if (jsPrep === 'js' && libs.includes('babel')) {
                    scriptAttr = 'type="text/babel" data-presets="react,typescript"';
                }

                const source = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        ${libs}
                        <style>${css}</style>
                        <script>
                            window.onerror = function(msg, url, line, col, error) {
                                document.body.innerHTML += '<div style="color:red; background:#fee; padding:10px; border:1px solid red; margin-top:20px; font-family:monospace;">Global Error: ' + msg + ' (Line: ' + line + ')</div>';
                                return false; 
                            };
                        <\/script>
                    </head>
                    <body>
                        ${html}
                        <script ${scriptAttr}>
                            try {
                                ${js}
                            } catch (err) {
                                document.body.innerHTML += '<div style="color:red; background:#fee; padding:10px; border:1px solid red; margin-top:20px;">Runtime Error: ' + err.message + '</div>';
                            }
                        <\/script>
                    </body>
                    </html>
                `;

                const iframeDoc = fullscreenFrame.contentDocument || fullscreenFrame.contentWindow.document;
                iframeDoc.open();
                iframeDoc.write(source);
                iframeDoc.close();

                fullscreenModal.classList.remove('hidden');
            }).catch(err => {
                alert("Error preparing fullscreen: " + err.message);
            });
        }

        function closeFullscreen() {
            fullscreenModal.classList.add('hidden');
        }

        document.addEventListener('keydown', function(event) {
            if (event.key === "Escape" && !fullscreenModal.classList.contains('hidden')) {
                closeFullscreen();
            }
        });

        // Full Script Preview Logic
        function showFullSource() {
            const rawHtml = htmlEditor.value;
            const rawCss = cssEditor.value;
            const rawJs = jsEditor.value;
            const libs = libContent.value;
            
            const cssPrep = cssPreprocessorSelect ? cssPreprocessorSelect.value : 'css';
            const jsPrep = jsPreprocessorSelect ? jsPreprocessorSelect.value : 'js';
            const htmlPrep = htmlPreprocessorSelect ? htmlPreprocessorSelect.value : 'html';

            let displayCss = rawCss;
            if(cssPrep !== 'css') {
                displayCss = `/* PREPROCESSOR: ${cssPrep.toUpperCase()} - CODE IS NOT COMPILED CSS */\n` + rawCss;
            }

            let displayJs = rawJs;
            if(jsPrep !== 'js') {
                displayJs = `/* PREPROCESSOR: ${jsPrep.toUpperCase()} - CODE IS NOT COMPILED JS */\n` + rawJs;
            }

            let displayHtml = rawHtml;
            if(htmlPrep !== 'html') {
                displayHtml = `<!-- PREPROCESSOR: ${htmlPrep.toUpperCase()} - CODE IS NOT COMPILED HTML -->\n` + rawHtml;
            }

            let scriptAttr = '';
            if (jsPrep === 'js' && libs.includes('babel')) {
                scriptAttr = 'type="text/babel" data-presets="react,typescript"';
            }

            const fullSource = `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Exported Project</title>
  ${libs}
  <style>
${displayCss}
  </style>
</head>
<body>
${displayHtml}

  <script ${scriptAttr}>
${displayJs}
  <\/script>
</body>
</html>`;

            fullSourceArea.value = fullSource;
            sourceModal.classList.remove('hidden');
        }

        function closeModal() {
            sourceModal.classList.add('hidden');
        }

        function copySource() {
            fullSourceArea.select();
            document.execCommand('copy');
            const btn = document.querySelector('button[onclick="copySource()"]');
            const originalText = btn.innerText;
            btn.innerText = "Tersalin!";
            setTimeout(() => btn.innerText = originalText, 1500);
        }

        // Custom Filename Download
        function downloadSource() {
            const content = fullSourceArea.value;
            const defaultName = 'project.html';
            
            // Minta input nama file dari user
            let fileName = prompt("Masukkan nama file untuk disimpan:", defaultName);
            
            // Jika user menekan Cancel, batalkan download
            if (fileName === null) return; 
            
            // Jika input kosong, gunakan nama default
            if (!fileName.trim()) {
                fileName = defaultName;
            }
            
            // Pastikan ekstensi file adalah .html
            if (!fileName.toLowerCase().endsWith('.html') && !fileName.toLowerCase().endsWith('.htm')) {
                fileName += '.html';
            }

            const blob = new Blob([content], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Core Compiler Logic - NOW ASYNC with Error Handling
        async function updatePreview() {
            try {
                // Safety check: ensure previewFrame exists
                if (!previewFrame) {
                    previewFrame = document.getElementById('preview-frame');
                    if (!previewFrame) return; // Exit if still null
                }

                const rawHtml = htmlEditor.value;
                const rawCss = cssEditor.value;
                const rawJs = jsEditor.value;
                const libs = libContent.value;
                const cssPrepType = cssPreprocessorSelect ? cssPreprocessorSelect.value : 'css';
                const jsPrepType = jsPreprocessorSelect ? jsPreprocessorSelect.value : 'js';
                const htmlPrepType = htmlPreprocessorSelect ? htmlPreprocessorSelect.value : 'html';

                localStorage.setItem('lc_html', rawHtml);
                localStorage.setItem('lc_css', rawCss);
                localStorage.setItem('lc_js', rawJs);
                localStorage.setItem('lc_libs', libs);
                localStorage.setItem('lc_css_preprocessor', cssPrepType);
                localStorage.setItem('lc_js_preprocessor', jsPrepType);
                localStorage.setItem('lc_html_preprocessor', htmlPrepType);

                // Update Placeholder logic (No changes needed here)
                if(cssPrepType === 'scss') cssEditor.placeholder = "/* Tulis SCSS di sini */";
                else if(cssPrepType === 'less') cssEditor.placeholder = "/* Tulis LESS di sini */";
                else cssEditor.placeholder = "/* Tulis CSS di sini */";

                if(jsPrepType === 'typescript') jsEditor.placeholder = "// Tulis TypeScript di sini (const x: number = 10;)";
                else if(jsPrepType === 'babel') jsEditor.placeholder = "// Tulis Modern JS/JSX di sini (const App = () => <h1>Hi</h1>)";
                else if(jsPrepType === 'coffeescript') jsEditor.placeholder = "# Tulis CoffeeScript di sini (square = (x) -> x * x)";
                else jsEditor.placeholder = "// Tulis JavaScript di sini";

                if(htmlPrepType === 'markdown') htmlEditor.placeholder = "<!-- Tulis Markdown di sini (# Hello World) -->";
                else if(htmlPrepType === 'pug') htmlEditor.placeholder = "//- Tulis Pug di sini (h1 Hello World)";
                else if(htmlPrepType === 'haml') htmlEditor.placeholder = "%h1 Hello Haml\n.container\n  %p Tulis Haml di sini...";
                else if(htmlPrepType === 'slim') htmlEditor.placeholder = "h1 Hello Slim\n.container\n  p Tulis Slim di sini...";
                else htmlEditor.placeholder = "<!-- Tulis HTML di sini -->";


                // Compile Everything if needed
                let compiledCss = rawCss;
                let compiledJs = rawJs;
                let compiledHtml = rawHtml;

                if (rawCss.trim()) {
                     compiledCss = await compileCSS(rawCss, cssPrepType);
                }
                
                // INJECT CENTER CSS IF ACTIVE
                if (isCentered) {
                    compiledCss += `
                        /* Auto-Injected by LiveCompiler Center Mode */
                        html {
                            height: 100% !important;
                            width: 100% !important;
                        }
                        body {
                            display: flex !important;
                            justify-content: center !important;
                            align-items: center !important;
                            min-height: 100vh !important;
                            width: 100% !important;
                            margin: 0 !important;
                            padding: 0 !important;
                        }
                    `;
                }

                if (rawJs.trim()) {
                     compiledJs = await compileJS(rawJs, jsPrepType);
                }
                if (rawHtml.trim()) {
                     compiledHtml = await compileHTML(rawHtml, htmlPrepType);
                }

                let scriptAttr = '';
                let scriptContent = '';
                
                // Detect ES Modules (import/export)
                const isModule = compiledJs.includes('import ') || compiledJs.includes('export ');

                // IMPORT MAP GENERATOR (New Feature)
                // Ini membantu browser menemukan 'three' saat di-import oleh library lain
                let importMap = '';
                if (isModule || libs.includes('three.js') || libs.includes('three.min.js')) {
                    importMap = `
                    <script type="importmap">
                      {
                        "imports": {
                          "three": "https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.module.js",
                          "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.128.0/examples/jsm/"
                        }
                      }
                    <\/script>`;
                }

                if (jsPrepType === 'js' && libs.includes('babel')) {
                    scriptAttr = 'type="text/babel" data-presets="react,typescript"';
                    scriptContent = `
                        try {
                            ${compiledJs}
                        } catch (err) {
                            document.body.innerHTML += '<div style="color:red; background:#fee; padding:10px; border:1px solid red; margin-top:20px;">Runtime Error: ' + err.message + '</div>';
                        }
                    `;
                } else if (isModule) {
                    scriptAttr = 'type="module"';
                    // Modules cannot be wrapped in try/catch block directly
                    // We attach error listener to window instead
                    scriptContent = compiledJs;
                } else {
                    // Standard JS
                    scriptContent = `
                        try {
                            ${compiledJs}
                        } catch (err) {
                            document.body.innerHTML += '<div style="color:red; background:#fee; padding:10px; border:1px solid red; margin-top:20px;">Runtime Error: ' + err.message + '</div>';
                        }
                    `;
                }

                const source = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        ${libs}
                        ${importMap}
                        <style>${compiledCss}</style>
                        <script>
                            window.onerror = function(msg, url, line, col, error) {
                                document.body.innerHTML += '<div style="color:red; background:#fee; padding:10px; border:1px solid red; margin-top:20px; font-family:monospace;">Global Error: ' + msg + ' (Line: ' + line + ')</div>';
                                return false; 
                            };
                        <\/script>
                    </head>
                    <body>
                        ${compiledHtml}
                        <script ${scriptAttr}>
                            ${scriptContent}
                        <\/script>
                    </body>
                    </html>
                `;

                const iframeDoc = previewFrame.contentDocument || previewFrame.contentWindow.document;
                iframeDoc.open();
                iframeDoc.write(source);
                iframeDoc.close();

                statusMsg.textContent = "Diperbarui: " + new Date().toLocaleTimeString();
            } catch (error) {
                console.error("Preview Update Error:", error);
                statusMsg.textContent = "Error: " + error.message;
            }
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args).catch(err => console.error("Debounce error:", err));
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Initialize App securely
        function startApp() {
             initElements();

             // Add Event Listeners for Modals
             if (sourceModal) {
                 sourceModal.addEventListener('click', (e) => {
                    if (e.target === sourceModal) {
                        closeModal();
                    }
                 });
             }

             if (librariesModal) {
                 librariesModal.addEventListener('click', (e) => {
                    if (e.target === librariesModal) {
                        closeLibraries();
                    }
                 });
             }

             const debouncedUpdate = debounce(updatePreview, 800);
             htmlEditor.addEventListener('input', debouncedUpdate);
             cssEditor.addEventListener('input', debouncedUpdate);
             jsEditor.addEventListener('input', debouncedUpdate);

             // Textarea indent logic
             document.querySelectorAll('textarea').forEach(textarea => {
                textarea.addEventListener('keydown', function(e) {
                    if (e.key === 'Tab') {
                        e.preventDefault();
                        const start = this.selectionStart;
                        const end = this.selectionEnd;
                        this.value = this.value.substring(0, start) + "  " + this.value.substring(end);
                        this.selectionStart = this.selectionEnd = start + 2;
                    }
                });
             });

             init();
        }

        // Run Init when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', startApp);
        } else {
            startApp();
        }

    </script>
</body>
</html>
